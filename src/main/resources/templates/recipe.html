<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"> 
<head>
    <meta charset="UTF-8">
    <title th:text="${recipe.title}">Dettaglio Ricetta</title>
    
    <link rel="stylesheet" href="/css/recipe.css" />
</head>

<body>
    <div class="magic-background"></div>

    <header>
        <div class="header-content-wrapper">
            <div class="left-nav-group">
                </div>

            <div class="header-user-section">
                <div th:if="${userDetails}">
                    <span class="chef-name">‚ú® Chef <span th:text="${userDetails.username}"></span></span>
                    <a href="/logout">Logout</a>
                </div>
                <div th:unless="${userDetails}">
                    <a href="/login">Login</a>
                </div>
            </div>
        </div>
    </header>

    <main class="fairy-card">
        
        <div class="corner top-left"></div>
        <div class="corner top-right"></div>
        <div class="corner bottom-left"></div>
        <div class="corner bottom-right"></div>

		<div class="title-section">
		    <h1 th:text="${recipe.title}">Titolo Ricetta</h1>

		    <div class="author-info">
		        <span th:if="${recipe.author != null}">
		            Chef: <strong th:text="${recipe.author.name} + ' ' + ${recipe.author.surname}">Nome Cognome</strong>
		        </span>
		        <span th:unless="${recipe.author != null}">
		            Chef Anonimo
		        </span>
		    </div>

		    <p class="subtitle" th:text="${recipe.description}">Descrizione...</p>
		</div>

        <div class="content-grid">
            
            <div class="left-column">
                
                <div class="magic-scroll-header">
                    <h2>Ingredienti</h2>
                </div>

                <ul class="ingredients-list">
                    <li th:each="ing : ${recipe.ingredients}">
                        <span class="star">‚òÖ</span> 
                        <span th:text="${ing.name}">Nome</span>
                        <span th:if="${ing.quantity} != null"> - <span th:text="${ing.quantity}">0</span></span>
                        <span th:if="${ing.unit} != null" th:text="${ing.unit}">unit√†</span>
                    </li>
                </ul>

                <div class="procedure-text">
                    <h3 style="color: #B8860B; font-family: 'Cinzel Decorative', serif; margin-bottom: 10px;">Procedimento:</h3>
                    <p th:text="${recipe.procedure}">Qui ci sar√† il procedimento...</p>
                </div>
            </div>

            <div class="right-column">
                
                <div class="magic-frame">
                    <img th:if="${recipe.imageUrl}" th:src="${recipe.imageUrl}" alt="Immagine Ricetta"/>
                    <img th:unless="${recipe.imageUrl}" src="/images/placeholder-piatto.jpg" alt="Nessuna immagine"/>
                </div>

                <div class="details-section">
                    <h3 class="cursive-sub">Dettagli Tecnici</h3>
                    <div class="separator-line"></div>
                    
                    <ul class="tech-list">
                        <li>
                            <strong>Tempo:</strong> 
                            <span th:text="${recipe.preparationTime} + ' minuti'"> min</span>
                        </li>
                        <li>
                            <strong>Difficolt√†:</strong> 
                            <span th:text="${recipe.difficulty}"></span>
                        </li>
                        
                        <li>
                            <strong>Cottura:</strong> 
                            <span th:text="${recipe.cookingTime != null} ? ${recipe.cookingTime} + ' minuti' : '-'">-</span>
                        </li>

                        <li>
                            <strong>Porzioni:</strong> 
                            <span th:text="${recipe.servings} != null ? ${recipe.servings} : '-'">4</span>
                        </li>
                        
                        <li>
                            <strong>Categoria:</strong> 
                            <span th:text="${recipe.category}">Categoria</span>
                        </li>
                        
                        <li th:if="${!recipe.tags.empty}">
                            <strong>Tag:</strong>
                            <span th:each="tag, iterStat : ${recipe.tags}" 
                                  th:text="${tag} + ${!iterStat.last ? ', ' : ''}">Tag</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="reviews-container">
            <h2 style="font-family: 'Cinzel Decorative', serif; color: #8B0000; text-align: center;">
                ‚ú® I Commenti 
            </h2>

            <div th:if="${!recipe.reviews.empty}">
                <div th:each="review : ${recipe.reviews}" class="review-card">
                    <div class="review-header">
                        <span class="review-author">üßô‚Äç‚ôÇÔ∏è Chef <span th:text="${review.user.name}">Nome</span></span>
                        <span class="stars">
                            <span th:if="${review.rating >= 1}">‚òÖ</span>
                            <span th:if="${review.rating >= 2}">‚òÖ</span>
                            <span th:if="${review.rating >= 3}">‚òÖ</span>
                            <span th:if="${review.rating >= 4}">‚òÖ</span>
                            <span th:if="${review.rating == 5}">‚òÖ</span>
                        </span>
                    </div>
                    <strong th:text="${review.title}" style="display:block; margin-bottom:5px;">Titolo</strong>
                    <p th:text="${review.text}" style="margin: 0; font-style: italic;">Testo recensione...</p>
                </div>
            </div>

            <div th:if="${recipe.reviews.empty}" style="text-align: center; font-style: italic; color: #666;">
                <p>Nessuna ricetta!</p>
            </div>

            <div sec:authorize="isAuthenticated()" class="review-form">
                <h3 style="font-family: 'Great Vibes', cursive; font-size: 1.8em; color: #8b4513;">
                    Lascia la tua opinione 
                </h3>
                
                <form th:action="@{'/recipe/' + ${recipe.id} + '/review'}" method="POST" th:object="${review}">
                    
                    <div th:if="${#fields.hasGlobalErrors()}" class="error-msg">
                        <p th:each="err : ${#fields.globalErrors()}" th:text="${err}"></p>
                    </div>

                    <div class="form-group">
                        <label>Titolo:</label>
                        <input type="text" th:field="*{title}" placeholder="Es: Deliziosa!" required />
                        <span th:if="${#fields.hasErrors('title')}" th:errors="*{title}" class="error-msg"></span>
                    </div>

                    <div class="form-group">
                        <label>Voto magico (1-5):</label>
                        <select th:field="*{rating}" required>
                            <option value="5">5 - Magico! ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</option>
                            <option value="4">4 - Ottimo ‚òÖ‚òÖ‚òÖ‚òÖ</option>
                            <option value="3">3 - Buono ‚òÖ‚òÖ‚òÖ</option>
                            <option value="2">2 - Cos√¨ cos√¨ ‚òÖ‚òÖ</option>
                            <option value="1">1 - Disastroso ‚òÖ</option>
                        </select>
                        <span th:if="${#fields.hasErrors('rating')}" th:errors="*{rating}" class="error-msg"></span>
                    </div>

                    <div class="form-group">
                        <label>La tua esperienza:</label>
                        <textarea th:field="*{text}" rows="3" placeholder="Scrivi qui..." required></textarea>
                        <span th:if="${#fields.hasErrors('text')}" th:errors="*{text}" class="error-msg"></span>
                    </div>

                    <button type="submit" class="magic-btn">Pubblica </button>
                </form>
            </div>

            <div sec:authorize="!isAuthenticated()" style="text-align: center; margin-top: 20px;">
                <p><em><a href="/login" style="color: #B8860B; font-weight: bold;">Accedi</a> per lasciare una recensione.</em></p>
            </div>
        </div>
        <div class="action-buttons-container">
            <a href="/recipes" class="magic-btn">
                ‚Üê Torna all'elenco
            </a>
            
            <span sec:authorize="hasAuthority('ADMIN')">
                <a th:href="@{'/admin/recipe/' + ${recipe.id} + '/edit'}" class="magic-btn edit-btn">
                    ‚úèÔ∏è Modifica ricetta
                </a>
            </span>
        </div>

        <div class="bottom-scroll-footer">
            <span>Una ricetta...</span>
        </div>

    </main>

</body>
</html>